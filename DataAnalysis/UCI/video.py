#!/usr/bin/python
# -*- coding: utf-8 -*-

###############################################################################
# Clustered video routines
###############################################################################
# In case of:
#   UnicodeDecodeError: 'utf-8' codec can't decode byte 0xf1
#   https://github.com/matplotlib/basemap/issues/324
# Depends on an obsolete structure (needs to be updated):
#   https://github.com/Chipdelmal/MoNeT/blob/master/DataAnalysis/ERACR/Yorkeys.py
#   https://github.com/Chipdelmal/MoNeT/tree/master/DataAnalysis/AggregationAndClustering
###############################################################################
import glob
import warnings
import subprocess
import auxVideo as aux
import auxCluster as auxC
import MoNeT_MGDrivE as monet
warnings.filterwarnings("ignore", category=UserWarning)

(BASE_PATH, DATA_PATH) = (
        '/Volumes/marshallShare/UCI/videoDemo/'
        '/Volumes/marshallShare/UCI/kernels/kernel_cluster_10k/'
    )
(dataFldr, expName, clstFldr, aggLvl, clstSample) = (
        'sims', 'stp_all_sites_cluster',
        'clustered', 'C0100', '000'
    )
(PAD, DPI) = (.1, 512)
###############################################################################
# Colors and genotypes
###############################################################################
colors = ['#090446', '#ff004d', '#7fff3a', '#9037dd', '#ffed38']
aggDict = monet.autoGenerateGenotypesDictionary(
        ['W', 'H', 'R', 'B'],
        ['WW', 'WH', 'WR', 'WB', 'HH', 'HR', 'HB', 'RR', 'RB', 'BB']
    )
###############################################################################
# File paths
###############################################################################
#   BASE_PATH: Root directory for the experiment
#   expFolder: Folder that contains the [ANALYZED, GARBAGE, RAW] sets
#   extras: Folder that contains the [MAP, VBG, CLS, CLL, AGG, AGCV] files
#       generated by the aggregation routines
#   expPath: Folder nested within the ANALYZED folder for parameters sweeps
#       (would be equal to expFolder in case it's not existing)
###############################################################################
(extras, expPath, outPath) = (
        BASE_PATH + clstFldr + '/',
        DATA_PATH + '/ANALYZED/0001/',
        BASE_PATH + 'video/'
    )
###############################################################################
# File names parsing
###############################################################################
#   VBG: Clustered PNG
#   CLL: Number of nodes in cluster?
#   CLS: {x, y, clusterID} -> contained now in "_I"
#   AGG: Aggregated migration matrix "_A"
#   AGCV: Clusters centroids? -> contained now in "_I"
###############################################################################
(patchFilePattern, imagePattern) = (
        {'male': '/M_*', 'female': '/F_*'}, 'c_%06d.png'
    )
(bgName, originalCoordFile) = (
        glob.glob(extras + aggLvl + '_' + clstSample + '*VBG.png')[0],
        glob.glob(extras + aggLvl + '_' + clstSample + '*I.csv')[0]
    )
(vname, imageLocation) = (outPath + 'STP.mp4', outPath + 'clustercharts/')
original_corners = aux.get_corners(originalCoordFile)
(coordinates, clstList) = (
        auxC.getClustersNewScheme(originalCoordFile),
        auxC.readClustersIDs(originalCoordFile)
    )
subprocess.Popen(['mkdir', imageLocation])
###############################################################################
# Create video
###############################################################################
clusters = auxC.populateClustersFromList(clstList, expPath, patchFilePattern)
aggList = monet.aggregateClusters(clusters, aggDict)
aux.generateClusterGraphs(
        originalCoordFile,
        aggList, coordinates, imageLocation, colors, original_corners,
        PAD, DPI, skip=False, countries=True, refPopSize=300
    )
